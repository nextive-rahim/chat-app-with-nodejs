<%- include('partials/commonHeader') %>

<div class="manageUser-container">
  <div id="title">
    <h2>Manage Users</h2>
  </div>

  <div class="new-message-container new-user">
    <a href="#" onclick="openModal(event)">+</a>
  </div>

  <div id="users-table">
    <table>
      <thead>
        <tr>
          <th scope="col">Name</th>
          <th scope="col">Email</th>
          <th scope="col">Manage</th>
        </tr>
      </thead>
      <tbody id="users-body">
        <% if (users.length === 0) { %>
          <tr>
            <td colspan="3">No users found</td>
          </tr>
        <% } else { %>
          <% users.forEach(user => { %>
            <tr id="user-<%= user._id %>">
              <td class="name">
                <!-- <img src="/uploads/avatars/<%= user.avatar || 'default-user.png' %>" 
                     onerror="this.src='/images/default-user.png'" /> -->
                <span><%= user.name %></span>
              </td>
              <td><%= user.email %></td>
              <td class="manage">
                <button onclick="deleteUser('<%= user._id %>')">
                  <img src="/images/trash.png" alt="Delete" />
                </button>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal-wrapper" id="add-user-modal">
  <div class="modal">
    <a href="#" onclick="closeModal(event)" class="modal-close">+</a>
    <div class="modal-title">
      <h2>Create New User</h2>
    </div>
    <div class="modal-body">
      <form id="add-user-form" enctype="multipart/form-data">
        <input type="text" name="name" placeholder="Enter name" required />
        <input type="email" name="email" placeholder="Enter email" required />
        <input type="text" name="mobile" placeholder="Enter mobile" required />
        <input type="password" name="password" placeholder="Enter password" required />
        <input type="file" name="avatar" />
        <input type="submit" value="Submit" />
      </form>
    </div>
  </div>
</div>

<script>
  // ----- Modal functions -----
  function openModal(event) {
    event.preventDefault();
    document.getElementById('add-user-modal').style.display = 'block';
  }

  function closeModal(event) {
    event.preventDefault();
    document.getElementById('add-user-modal').style.display = 'none';
  }

  // ----- Add new user -----
  document.getElementById('add-user-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    try {
      const res = await fetch('/users/add', {
        method: 'POST',
        body: formData
      });
      const result = await res.json();

      if (result.success) {
        alert('User added successfully!');
        this.reset();
        closeModal(new Event('click'));
        location.reload(); // reload page to show new user
      } else {
        alert(result.message || 'Failed to add user');
      }
    } catch (err) {
      console.error(err);
      alert('Something went wrong!');
    }
  });

  // ----- Delete user -----
  async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;

    try {
      const res = await fetch(`/users/delete/${userId}`, { method: 'DELETE' });
      const result = await res.json();
      if (result.success) {
        alert('User deleted successfully!');
        document.getElementById(`user-${userId}`).remove(); // remove row dynamically
      } else {
        alert(result.message || 'Failed to delete user');
      }
    } catch (err) {
      console.error(err);
      alert('Something went wrong!');
    }
  }
</script>
</body>
</html>
